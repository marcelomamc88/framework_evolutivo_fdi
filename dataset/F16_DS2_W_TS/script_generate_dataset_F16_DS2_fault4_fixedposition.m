%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%% GENERATE FAULT 4 DATA TO DATASET2 (CHANGE ANGLE AND TORQUE ON THE SURFACE MANEUVER) %%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% INTERACTING WITH SIMULINK MODEL FROM A MATLAB SCRIPT
% https://www.youtube.com/watch?v=sF_sjFqNFUk
% FAULT 4: Fixed Valve Position
% PARAMETER AFFECTED: cylinder A position

clear
clc
close all

epochs = 150;
downsample_factor = 100;
file_name = 'F16_DS2_fault4_fixedposition.csv';
m = [-1, 1];
choices_refangle_basevalue = [-5:.1:5]/10.0;  
choices_refangle_amplitude = [.01:.04:.5];
choices_ts_basevalue = [5:.1:10];   
choices_ts_amplitude = [1:.1:5];

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% DEFAULT VALUES - NO FAULT %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
fault_time = 20; %seconds

for i=1:epochs
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %% Generating Random Values %%
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    % random RefAngle - Base Value => [-.5, .5]      
    refangle_basevalue = choices_refangle_basevalue(randi([1 length(choices_refangle_basevalue)],1,1));

    % random RefAngle - Amplitude => +-[.01, .5]    
    refangle_amplitude = choices_refangle_amplitude(randi([1 length(choices_refangle_amplitude)],1,1))  * m(randi([1 2],1,1));

    % random Torque on the Surface - Base Value => [5,10]    
    torque_basevalue = choices_ts_basevalue(randi([1 length(choices_ts_basevalue)],1,1));

    % random Torque on the Surface - Amplitude => +-[1,5]
    torque_amplitude = choices_ts_amplitude(randi([1 length(choices_ts_amplitude)],1,1)) * m(randi([1 2],1,1));

    % Time Start Maneuver => [5,50]
    timestart_maneuver = randi([5 50],1,1);

    % Time End Maneuver => start + [10,50]
    timeend_maneuver = timestart_maneuver + randi([10 50],1,1);
    
    %%%%%%%%%%%%%%%%%%
    %% Setup Values %%
    %%%%%%%%%%%%%%%%%%

    % SURFACE ANGLE MANUEVER
    input.refangle.basevalue = refangle_basevalue;
    input.refangle.amplitude = refangle_amplitude;
    input.refangle.timestart = timestart_maneuver;
    input.refangle.timeend  = timeend_maneuver;

    % TORQUE ON THE SURFACE MANEUVER
    input.torque.basevalue = torque_basevalue;
    input.torque.amplitude = torque_amplitude;    
    input.torque.timestart = timestart_maneuver;
    input.torque.timeend  = timeend_maneuver;
    
    % FAULT BETA
    input.beta.amplitude = 0;
    input.beta.time = 0;
    
    % FAULT BP
    input.bp.amplitude = 0;
    input.bp.time = 0;
    
    % FAULT C LEAK
    input.c_leak.amplitude = 0;
    input.c_leak.time = 0;
    
    % FAULT VALVE POSITION
    input.valve.fault = 0; %valve position
    input.valve.amplitude = 1; %1 - fault activate
    input.valve.time = fault_time;

    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %% run the simulink model using the 'sim' command %%
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    sim('F16_DS2_W_TS_SIMULINK.slx');
    
    % extract the data generated by the simulink model
    output_arr = ans.simout_arr;
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %% downsample via Hamming Window (fir) %%     
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    read_1 = decimate(output_arr(:,1), downsample_factor,'fir');
    output_reduced = zeros(size(read_1, 1), 25);
    output_reduced(:,1) = read_1;
    for j=2:size(output_arr,2)
        output_reduced(:,j) = decimate(output_arr(:,j), downsample_factor,'fir');   
    end
    
    %%%%%%%%%%%%%%%%%%
    %% save in file %%
    %%%%%%%%%%%%%%%%%%
    writematrix(output_reduced, file_name, 'WriteMode', 'append');
end


