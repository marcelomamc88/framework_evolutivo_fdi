%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%% GENERATE NO FAULT DATA TO DATASET1 (CHANGE ALTITUDE MANEUVER) %%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% INTERACTING WITH SIMULINK MODEL FROM A MATLAB SCRIPT
% https://www.youtube.com/watch?v=sF_sjFqNFUk

clear
clc
close all

epochs = 300;
downsample_factor = 100;
file_name = 'F16_DS1_normal.csv';

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% DEFAULT VALUES - NO FAULT %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

for i=1:epochs
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %% Generating Random Values %%
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    % random amplitude =>  +- [20, 80]
    reference = [-1, 1];
    choose = randi([1 2],1,1);
    amplitude = randi([20 80],1,1) * reference(choose);
    
    % random time_start =>  [5, 60]
    time_start = randi([5 60],1,1);
    
    % random time_end => time_start + [30,80]
    time_end = time_start + randi([30 80],1,1);
    
    %%%%%%%%%%%%%%%%%%
    %% Setup Values %%
    %%%%%%%%%%%%%%%%%%

    % ALTITUDE MANUEVER
    input.altitude.amplitude = amplitude;
    input.altitude.timestart = time_start;
    input.altitude.timeend = time_end;
    
    % FAULT BETA
    input.beta.amplitude = 0;
    input.beta.time = 0;
    
    % FAULT BP
    input.bp.amplitude = 0;
    input.bp.time = 0;
    
    % FAULT C LEAK
    input.c_leak.amplitude = 0;
    input.c_leak.time = 0;
    
    % FAULT VALVE POSITION
    input.valve.fault = 0;
    input.valve.amplitude = 0;
    input.valve.time = 0;

    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %% run the simulink model using the 'sim' command %%
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    sim('F16_DS1_ALTITUDE_SIMULINK.slx');
    
    % extract the data generated by the simulink model
    output_arr = ans.simout_arr;
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %% downsample via Hamming Window (fir) %%     
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    read_1 = decimate(output_arr(:,1), downsample_factor,'fir');
    output_reduced = zeros(size(read_1, 1), 25);
    output_reduced(:,1) = read_1;
    for i=2:size(output_arr,2)
        output_reduced(:,i) = decimate(output_arr(:,i), downsample_factor,'fir');   
    end
    
    %%%%%%%%%%%%%%%%%%
    %% save in file %%
    %%%%%%%%%%%%%%%%%%
    writematrix(output_reduced, file_name, 'WriteMode', 'append');
end


